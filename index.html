<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />

  <!-- âœ… iOS í™ˆí™”ë©´(standalone)ì—ì„œ í™”ë©´ ë§ì¶¤ í•µì‹¬ -->
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>ì†ëª© ì¬í™œ ì²´í¬</title>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0b1220; --card:#111a2d; --muted:#93a4c7; --text:#e8eefc; --line:#223052;
      --primary:#2563eb; --danger:#b91c1c; --good:#22c55e; --warn:#f59e0b;

      --sa-top: env(safe-area-inset-top, 0px);
      --sa-bottom: env(safe-area-inset-bottom, 0px);
      --sa-left: env(safe-area-inset-left, 0px);
      --sa-right: env(safe-area-inset-right, 0px);

      /* âœ… iOS ë†’ì´ ë³´ì • ë³€ìˆ˜ (JSë¡œ ì„¤ì •) */
      --vh: 1vh;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Malgun Gothic",Segoe UI,Roboto,sans-serif;
      background:linear-gradient(180deg,#071023,#0b1220);
      color:var(--text);

      /* iPhone safe area */
      padding-left: var(--sa-left);
      padding-right: var(--sa-right);

      /* âœ… iOSì—ì„œ í™ˆí™”ë©´ ì‹¤í–‰ ì‹œ ìŠ¤í¬ë¡¤ ë°”ìš´ìŠ¤/ì˜ë¦¼ ì™„í™” */
      overscroll-behavior-y: none;
      -webkit-overflow-scrolling: touch;
    }

    /* âœ… í™”ë©´ë¹„ìœ¨/ë†’ì´ ë¬¸ì œ í•´ê²°ìš© ìµœìƒìœ„ ë˜í¼ */
    .app{
      min-height: calc(var(--vh) * 100);
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:20;
      background:rgba(11,18,32,.88);
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding: calc(12px + var(--sa-top)) 14px 12px 14px;
    }
    .titleRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .title{ font-size:18px; font-weight:900; letter-spacing:-0.2px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }
    .btn{
      background:#1f2a44; border:1px solid rgba(255,255,255,.10);
      color:var(--text); padding:10px 12px; border-radius:12px;
      font-weight:700; cursor:pointer; white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); }
    .btn.danger{ background:var(--danger); border-color:var(--danger); }
    .btn.ghost{ background:transparent; }
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      background:#0f172a; border:1px solid rgba(255,255,255,.10);
      color:var(--muted); font-size:12px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:14px;

      /* âœ… í™ˆ ì¸ë””ì¼€ì´í„° ì˜ì—­ í™•ë³´ */
      padding-bottom: calc(18px + var(--sa-bottom));
    }

    /* Mobile-first: 1 column */
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 920px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }

    .card{
      background:rgba(17,26,45,.94);
      border:1px solid rgba(255,255,255,.09);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .card.soft{ background:rgba(15,23,42,.68); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .sp{ justify-content:space-between; }
    .h2{ font-size:14px; font-weight:900; margin:0 0 10px 0; color:#dbe7ff; }
    .sep{ height:1px; background:rgba(255,255,255,.08); margin:12px 0; }
    .kpi{ font-size:28px; font-weight:950; letter-spacing:-0.6px; }
    .kpiSub{ font-size:12px; color:var(--muted); margin-top:2px; }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input[type="time"], input[type="number"], input[type="text"], textarea, select{
      width:100%;
      background:#0f172a;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-size:16px; /* iOS zoom ë°©ì§€ */
    }
    textarea{ min-height:76px; resize:vertical; }

    .cols{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 380px){
      .cols{ grid-template-columns:1fr; }
    }

    .check{ width:20px; height:20px; accent-color:var(--primary); }
    .tag{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:#0f172a; color:var(--muted);
    }

    /* Calendar */
    .calHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .month{ font-weight:950; }
    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
    .dow{ font-size:11px; color:var(--muted); text-align:center; padding:2px 0; }
    .day{
      background:#0f172a; border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:10px; min-height:74px; cursor:pointer;
    }
    .day.off{ opacity:.35; }
    .day .d{ font-size:12px; color:var(--muted); }
    .marks{ display:flex; gap:4px; margin-top:8px; }
    .m{ width:10px; height:10px; border-radius:4px; border:1px solid rgba(255,255,255,.14); background:transparent; }
    .m.on{ background:var(--good); border-color:var(--good); }
    .m.part{ background:var(--warn); border-color:var(--warn); }
    .today{ outline:2px solid rgba(37,99,235,.65); }

    /* Bottom status */
    .status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      opacity:.95;
    }

    /* Guide modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding: calc(10px + var(--sa-bottom)) 12px;
    }
    .modal{
      width:min(860px, 100%);
      background:rgba(17,26,45,.98);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.40);
      overflow:hidden;
    }
    .modalTop{
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalBody{
      max-height: 70vh;
      overflow:auto;
      padding:14px;
    }
    .guideBox{
      background:#0f172a;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      margin-bottom:10px;
    }
    .gTitle{ font-weight:900; margin:0 0 8px 0; }
    .gList{ margin:0; padding-left:18px; color:var(--text); }
    .gList li{ margin:6px 0; line-height:1.35; }
    .muted{ color:var(--muted); }

    @media (display-mode: standalone){
      body{ background:linear-gradient(180deg,#060c1a,#0b1220); }
    }
  </style>

  <!-- âœ… iOS â€œí™ˆí™”ë©´ ì‹¤í–‰â€ì—ì„œ 100vh ì˜¤ì‘ë™ ì¡ëŠ” í•µì‹¬ JS -->
  <script>
    function setVH(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    document.addEventListener('visibilitychange', () => { if(!document.hidden) setVH(); });
    setVH();
  </script>
</head>

<body>
  <!-- âœ… ì „ì²´ë¥¼ .appìœ¼ë¡œ ê°ì‹¸ì„œ ë†’ì´ ë³´ì • ì ìš© -->
  <div class="app">

<header>
  <div class="titleRow">
    <div>
      <div class="title">ì†ëª© ì¬í™œ ì²´í¬</div>
      <div class="sub">1ì¼ 3íšŒ(ê° 60ë¶„) + íŠ¹ì´ì‚¬í•­ 1ì¤„ Â· ë°ì´í„°ëŠ” ë‚´ í°ì—ë§Œ ì €ì¥</div>
    </div>
    <div class="row" style="gap:8px;">
      <button class="btn" id="btnGuide">ê¸°ë³¸ ìš´ë™ ì§€ì¹¨</button>
      <button class="btn" id="btnToday">ì˜¤ëŠ˜ë¡œ</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Today -->
    <section class="card" id="todayCard">
      <div class="row sp">
        <div>
          <div class="h2">ì˜¤ëŠ˜ ê¸°ë¡</div>
          <div class="pill" id="todayLabel"></div>
        </div>
        <div class="row">
          <span class="tag" id="goalTag">ëª©í‘œ: 3íšŒ</span>
          <button class="btn danger" id="btnResetDay">ì˜¤ëŠ˜ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row sp">
        <div>
          <div class="kpi" id="progressKpi">0/3</div>
          <div class="kpiSub">ì˜¤ëŠ˜ ì™„ë£Œ ì„¸ì…˜ ìˆ˜</div>
        </div>
        <button class="btn primary" id="btnSave">ì €ì¥</button>
      </div>

      <div class="sep"></div>

      <div class="grid" style="gap:12px;">
        <div class="card soft">
          <div class="row sp">
            <div class="h2" style="margin:0;">1íšŒì°¨</div>
            <label class="row" style="gap:8px; margin:0;">
              <input class="check" type="checkbox" id="s1_done" /> ì™„ë£Œ
            </label>
          </div>
          <div class="cols">
            <div><label>ì‹œì‘</label><input type="time" id="s1_start" /></div>
            <div><label>ì¢…ë£Œ</label><input type="time" id="s1_end" /></div>
          </div>
        </div>

        <div class="card soft">
          <div class="row sp">
            <div class="h2" style="margin:0;">2íšŒì°¨</div>
            <label class="row" style="gap:8px; margin:0;">
              <input class="check" type="checkbox" id="s2_done" /> ì™„ë£Œ
            </label>
          </div>
          <div class="cols">
            <div><label>ì‹œì‘</label><input type="time" id="s2_start" /></div>
            <div><label>ì¢…ë£Œ</label><input type="time" id="s2_end" /></div>
          </div>
        </div>

        <div class="card soft">
          <div class="row sp">
            <div class="h2" style="margin:0;">3íšŒì°¨</div>
            <label class="row" style="gap:8px; margin:0;">
              <input class="check" type="checkbox" id="s3_done" /> ì™„ë£Œ
            </label>
          </div>
          <div class="cols">
            <div><label>ì‹œì‘</label><input type="time" id="s3_start" /></div>
            <div><label>ì¢…ë£Œ</label><input type="time" id="s3_end" /></div>
          </div>
        </div>

        <div>
          <label>íŠ¹ì´ì‚¬í•­ (í•œ ì¤„)</label>
          <textarea id="note" placeholder="ì˜ˆ: 2íšŒì°¨ íšŒì „ ì‹œ ì²™ê³¨ í†µì¦â†‘ / ì»¨ë””ì…˜â†“ë¡œ ê°•ë„ ë‚®ì¶¤"></textarea>
        </div>

        <div class="status">
          <span id="statusBar">ì¤€ë¹„ë¨</span>
          <span class="muted">ìë™ ì €ì¥: ON</span>
        </div>
      </div>
    </section>

    <!-- Calendar + Weekly -->
    <section class="card">
      <div class="calHead">
        <button class="btn" id="prevMonth">â—€</button>
        <div class="month" id="monthLabel">2026ë…„ 1ì›”</div>
        <button class="btn" id="nextMonth">â–¶</button>
      </div>

      <div class="cal">
        <div class="dow">ì¼</div><div class="dow">ì›”</div><div class="dow">í™”</div><div class="dow">ìˆ˜</div><div class="dow">ëª©</div><div class="dow">ê¸ˆ</div><div class="dow">í† </div>
      </div>
      <div class="cal" id="calendar"></div>

      <div class="sep"></div>

      <div class="row sp">
        <div>
          <div class="h2">ğŸ“ ì£¼ê°„ ê°ë„ ì²´í¬ (ì„ íƒ)</div>
          <div class="muted" style="font-size:12px;">ì£¼ 1íšŒ ì •ë„ë§Œ ê¸°ë¡ ê¶Œì¥</div>
        </div>
        <button class="btn" id="btnSaveAngles">ê°ë„ ì €ì¥</button>
      </div>

      <div class="cols">
        <div>
          <label>ì£¼ì°¨ (ì˜ˆ: 6ì£¼ì°¨)</label>
          <input type="text" id="wk_label" placeholder="ì˜ˆ: 6ì£¼ì°¨" />
        </div>
        <div>
          <label>íšŒì „ ë³€í™”</label>
          <select id="wk_rot">
            <option value="">ì„ íƒ</option>
            <option value="ì¦ê°€">ì¦ê°€</option>
            <option value="ë™ì¼">ë™ì¼</option>
            <option value="ê°ì†Œ">ê°ì†Œ</option>
          </select>
        </div>
      </div>
      <div class="cols" style="margin-top:10px;">
        <div><label>êµ´ê³¡(Â°)</label><input type="number" id="wk_flex" min="0" max="180" placeholder="ì˜ˆ: 35" /></div>
        <div><label>ì‹ ì „(Â°)</label><input type="number" id="wk_ext" min="0" max="180" placeholder="ì˜ˆ: 20" /></div>
      </div>
      <div style="margin-top:10px;">
        <label>ëŠë‚Œ í•œ ì¤„</label>
        <input type="text" id="wk_note" placeholder="ì˜ˆ: ì €í•­ì´ ëœí•˜ê³  ëë²”ìœ„ ìœ ì§€ê°€ ì‰¬ì›€" />
      </div>

      <div class="sep"></div>

      <div class="row sp">
        <button class="btn danger" id="btnExport">ë°ì´í„° ë‚´ë³´ë‚´ê¸°(JSON)</button>
        <button class="btn" id="btnImport">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
      </div>
      <input type="file" id="importFile" accept="application/json" style="display:none;" />
    </section>

  </div>
</div>

<!-- Guide Modal -->
<div class="modalBack" id="guideBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="ê¸°ë³¸ ìš´ë™ ì§€ì¹¨">
    <div class="modalTop">
      <div style="font-weight:950;">ê¸°ë³¸ ìš´ë™ ì§€ì¹¨</div>
      <button class="btn ghost" id="btnGuideClose">ë‹«ê¸°</button>
    </div>
    <div class="modalBody">
      <div class="guideBox">
        <p class="gTitle">ğŸ§  ê¸°ë³¸ ì›ì¹™</p>
        <ul class="gList">
          <li>í•˜ë£¨ <b>3íšŒ</b> Â· 1íšŒ <b>60ë¶„</b> (í•œ ë²ˆì— ê¸¸ê²Œ í•˜ê±°ë‚˜ ìª¼ê°œë„ ë˜ì§€ë§Œ, â€œì´ëŸ‰â€ì„ ì§€í‚¤ëŠ” ê²Œ í•µì‹¬)</li>
          <li><b>ì²œì²œíˆ</b> + <b>ë°˜ë™ ê¸ˆì§€</b> (ëê°ë„ì—ì„œ 2~3ì´ˆ ìœ ì§€)</li>
          <li>â€œë‹¹ê¹€/ë»ê·¼í•¨â€ì€ OK, <b>ì°Œë¥´ëŠ” í†µì¦</b>Â·<b>ì €ë¦¿í•œ ì „ê¸°ê°</b>Â·<b>ê°‘ìê¸° í˜ ë¹ ì§</b>ì€ ì¦‰ì‹œ ì¤‘ë‹¨</li>
          <li>ìš´ë™ í›„ <b>ë¶“ê¸°/ì—´ê°</b>ì´ ì˜¬ë¼ì˜¤ë©´ ê°•ë„/ì‹œê°„ì„ ë‚®ì¶”ê³  ëƒ‰ì°œì§ˆ(ì˜ì‚¬ ì§€ì‹œ ìš°ì„ )</li>
        </ul>
      </div>

      <div class="guideBox">
        <p class="gTitle">ğŸ– ì†ëª©(íšŒì „ í¬í•¨) í•µì‹¬</p>
        <ul class="gList">
          <li><b>íšŒì „(íšŒë‚´/íšŒì™¸)</b>: ëê°ë„ì—ì„œ 2~3ì´ˆ â€œìœ ì§€â€ê°€ ì¤‘ìš”. í•˜ë£¨ ëˆ„ì ëŸ‰ìœ¼ë¡œ ì„œì„œíˆ í’€ë¦¼</li>
          <li><b>êµ´ê³¡/ì‹ ì „</b>: ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ ë¶€ë“œëŸ½ê²Œ, â€œëì—ì„œ ì‚´ì§ ë©ˆì¶¤â€</li>
          <li>ë¼ˆ/ì² ë¬¼ ë¶€ìœ„ì˜ <b>ë‹¹ê¹€</b>ì€ í”í•˜ì§€ë§Œ, <b>ì¹¼ë¡œ ì°Œë¥´ëŠ” í†µì¦</b>ì´ ë°˜ë³µë˜ë©´ ì§„ë£Œ ë•Œ ê¼­ ë§í•˜ê¸°</li>
        </ul>
      </div>

      <div class="guideBox">
        <p class="gTitle">âœ‹ ì†ê°€ë½/ì—„ì§€(í˜ì¤„ ìˆ˜ìˆ  í›„)</p>
        <ul class="gList">
          <li>ì†ëª©ì„ ì†ë“± ìª½ìœ¼ë¡œ ì –íˆë©´ ì†ê°€ë½ì´ êµ¬ë¶€ëŸ¬ì§€ê³ , ì†ë°”ë‹¥ ìª½ìœ¼ë¡œ êµ½íˆë©´ ì†ê°€ë½ì´ í´ì§€ëŠ” í˜„ìƒì€ <b>ì •ìƒì ì¸ í˜ì¤„ ì—°ë™</b>ì¼ ìˆ˜ ìˆìŒ</li>
          <li>ì£¼ë¨¹ì„ ì¥˜ ë•Œ ì†ëª©ì´ ëœ êº¾ì´ëŠ” ê²ƒë„ í”í•¨(í˜ì¤„/ê·¼ìœ¡ ê¸´ì¥ ë•Œë¬¸)</li>
          <li>ì—„ì§€â€“ê²€ì§€ ë™ì‹œ ì›€ì§ì„ì„ ì‹œí‚¤ëŠ” ê±´ â€œìƒˆë¡œ ì—°ê²°ëœ ë¼ì¸â€ì„ ì•ˆì •ì ìœ¼ë¡œ ì“°ê²Œ í•˜ë ¤ëŠ” ëª©ì ì¼ ìˆ˜ ìˆìŒ(ë‹´ë‹¹ì˜ ì§€ì‹œ ìš°ì„ )</li>
        </ul>
      </div>

      <div class="guideBox">
        <p class="gTitle">ğŸš¨ â€œë°”ë¡œ ë³‘ì›â€ ê¸°ì¤€</p>
        <ul class="gList">
          <li>í†µì¦ì´ <b>ë‚ ë§ˆë‹¤ ì¦ê°€</b>í•˜ê±°ë‚˜, ìš´ë™ í›„ <b>ë¶“ê¸°/ì—´ê°</b>ì´ ëšœë ·í•´ì§</li>
          <li>ì†/ì†ê°€ë½ <b>ê°ê° ì €í•˜</b>ê°€ ìƒˆë¡œ ìƒê¸°ê±°ë‚˜ ì•…í™”, ì†ëì´ ì°½ë°±/ì²­ìƒ‰ìœ¼ë¡œ ë³€í•¨</li>
          <li>íšŒì „ì´ 2ì£¼ ì´ìƒ â€œì™„ì „ ì •ì²´â€ + ì¼ìƒ ê¸°ëŠ¥ì´ ê¸‰ê²©íˆ ë–¨ì–´ì§</li>
        </ul>
        <div class="muted" style="font-size:12px; margin-top:10px;">
          â€» ì´ ì§€ì¹¨ì€ â€œê¸°ë³¸ ì›ì¹™â€ì´ê³ , <b>ë‹´ë‹¹ êµìˆ˜ ì§€ì‹œê°€ ìµœìš°ì„ </b>ì…ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "wristRehab_v2";
  const defaultData = { days: {}, weeklyAngles: [] };

  function pad(n){ return String(n).padStart(2,"0"); }
  function ymd(d){
    const dt = new Date(d);
    return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate());
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : structuredClone(defaultData);
    }catch(e){
      return structuredClone(defaultData);
    }
  }
  function saveData(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  let data = loadData();
  let selectedDate = new Date();
  let viewYear = selectedDate.getFullYear();
  let viewMonth = selectedDate.getMonth();

  // UI refs
  const todayLabel = document.getElementById("todayLabel");
  const progressKpi = document.getElementById("progressKpi");
  const monthLabel = document.getElementById("monthLabel");
  const calendarEl = document.getElementById("calendar");
  const statusBar = document.getElementById("statusBar");

  const fields = {
    s1_start: document.getElementById("s1_start"),
    s1_end: document.getElementById("s1_end"),
    s1_done: document.getElementById("s1_done"),
    s2_start: document.getElementById("s2_start"),
    s2_end: document.getElementById("s2_end"),
    s2_done: document.getElementById("s2_done"),
    s3_start: document.getElementById("s3_start"),
    s3_end: document.getElementById("s3_end"),
    s3_done: document.getElementById("s3_done"),
    note: document.getElementById("note"),
  };

  const wk = {
    label: document.getElementById("wk_label"),
    rot: document.getElementById("wk_rot"),
    flex: document.getElementById("wk_flex"),
    ext: document.getElementById("wk_ext"),
    note: document.getElementById("wk_note"),
  };

  function ensureDay(key){
    if(!data.days[key]){
      data.days[key] = {
        sessions: [
          {start:"", end:"", done:false},
          {start:"", end:"", done:false},
          {start:"", end:"", done:false},
        ],
        note: ""
      };
    }
    return data.days[key];
  }
  function calcDone(day){
    const d = day?.sessions || [];
    return d.filter(s=>s.done).length;
  }

  function renderToday(){
    const key = ymd(selectedDate);
    todayLabel.textContent = key;
    const day = ensureDay(key);

    fields.s1_start.value = day.sessions[0].start || "";
    fields.s1_end.value = day.sessions[0].end || "";
    fields.s1_done.checked = !!day.sessions[0].done;

    fields.s2_start.value = day.sessions[1].start || "";
    fields.s2_end.value = day.sessions[1].end || "";
    fields.s2_done.checked = !!day.sessions[1].done;

    fields.s3_start.value = day.sessions[2].start || "";
    fields.s3_end.value = day.sessions[2].end || "";
    fields.s3_done.checked = !!day.sessions[2].done;

    fields.note.value = day.note || "";
    progressKpi.textContent = calcDone(day) + "/3";
  }

  function readFormToData(){
    const key = ymd(selectedDate);
    const day = ensureDay(key);
    day.sessions[0] = { start: fields.s1_start.value, end: fields.s1_end.value, done: fields.s1_done.checked };
    day.sessions[1] = { start: fields.s2_start.value, end: fields.s2_end.value, done: fields.s2_done.checked };
    day.sessions[2] = { start: fields.s3_start.value, end: fields.s3_end.value, done: fields.s3_done.checked };
    day.note = fields.note.value || "";
  }

  function autoSave(){
    readFormToData();
    saveData(data);
    progressKpi.textContent = calcDone(data.days[ymd(selectedDate)]) + "/3";
    statusBar.textContent = "ì €ì¥ë¨ Â· " + new Date().toLocaleTimeString();
    renderCalendar();
  }

  Object.values(fields).forEach(el=>{
    el.addEventListener("input", autoSave);
    el.addEventListener("change", autoSave);
  });

  document.getElementById("btnSave").addEventListener("click", ()=>{
    autoSave();
    alert("ì €ì¥ ì™„ë£Œ");
  });

  document.getElementById("btnResetDay").addEventListener("click", ()=>{
    if(!confirm("ì˜¤ëŠ˜ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
    const key = ymd(selectedDate);
    data.days[key] = {
      sessions:[{start:"",end:"",done:false},{start:"",end:"",done:false},{start:"",end:"",done:false}],
      note:""
    };
    saveData(data);
    renderToday();
    renderCalendar();
    statusBar.textContent = "ì˜¤ëŠ˜ ì´ˆê¸°í™”ë¨";
  });

  document.getElementById("btnToday").addEventListener("click", ()=>{
    selectedDate = new Date();
    viewYear = selectedDate.getFullYear();
    viewMonth = selectedDate.getMonth();
    renderCalendar();
    renderToday();
  });

  // Calendar
  function renderCalendar(){
    calendarEl.innerHTML = "";
    monthLabel.textContent = `${viewYear}ë…„ ${viewMonth+1}ì›”`;

    const first = new Date(viewYear, viewMonth, 1);
    const startDay = first.getDay();
    const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
    const prevDays = new Date(viewYear, viewMonth, 0).getDate();

    for(let i=0;i<42;i++){
      const cell = document.createElement("div");
      cell.className = "day";

      let dayNum, cellDate, off=false;
      if(i < startDay){
        dayNum = prevDays - (startDay - 1 - i);
        cellDate = new Date(viewYear, viewMonth-1, dayNum);
        off = true;
      }else if(i >= startDay + daysInMonth){
        dayNum = i - (startDay + daysInMonth) + 1;
        cellDate = new Date(viewYear, viewMonth+1, dayNum);
        off = true;
      }else{
        dayNum = i - startDay + 1;
        cellDate = new Date(viewYear, viewMonth, dayNum);
      }

      const key = ymd(cellDate);
      const day = data.days[key];

      const d = document.createElement("div");
      d.className = "d";
      d.textContent = dayNum;
      cell.appendChild(d);

      const marks = document.createElement("div");
      marks.className = "marks";
      for(let k=0;k<3;k++){
        const m = document.createElement("div");
        m.className = "m";
        if(day){
          if(day.sessions[k]?.done) m.classList.add("on");
          else if(day.sessions[k]?.start || day.sessions[k]?.end) m.classList.add("part");
        }
        marks.appendChild(m);
      }
      cell.appendChild(marks);

      if(off) cell.classList.add("off");

      const today = new Date();
      if(ymd(today) === key) cell.classList.add("today");

      cell.addEventListener("click", ()=>{
        selectedDate = cellDate;
        viewYear = selectedDate.getFullYear();
        viewMonth = selectedDate.getMonth();
        renderCalendar();
        renderToday();
        window.scrollTo({top:0, behavior:"smooth"});
      });

      calendarEl.appendChild(cell);
    }
  }

  document.getElementById("prevMonth").addEventListener("click", ()=>{
    viewMonth--;
    if(viewMonth<0){ viewMonth=11; viewYear--; }
    renderCalendar();
  });
  document.getElementById("nextMonth").addEventListener("click", ()=>{
    viewMonth++;
    if(viewMonth>11){ viewMonth=0; viewYear++; }
    renderCalendar();
  });

  document.getElementById("btnSaveAngles").addEventListener("click", ()=>{
    const item = {
      date: ymd(new Date()),
      weekLabel: wk.label.value || "",
      flex: wk.flex.value ? Number(wk.flex.value) : null,
      ext: wk.ext.value ? Number(wk.ext.value) : null,
      rot: wk.rot.value || "",
      note: wk.note.value || ""
    };
    data.weeklyAngles.push(item);
    saveData(data);
    statusBar.textContent = "ê°ë„ ê¸°ë¡ ì €ì¥ë¨";
    alert("ì£¼ê°„ ê°ë„ ê¸°ë¡ ì €ì¥ ì™„ë£Œ");
  });

  // Export/Import
  document.getElementById("btnExport").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "wrist-rehab-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });
  document.getElementById("btnImport").addEventListener("click", ()=>{
    document.getElementById("importFile").click();
  });
  document.getElementById("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object") throw new Error("invalid");
      data = obj;
      saveData(data);
      renderCalendar();
      renderToday();
      alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
    }catch(err){
      alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: íŒŒì¼ì´ ì˜¬ë°”ë¥¸ JSONì´ ì•„ë‹™ë‹ˆë‹¤.");
    }finally{
      e.target.value = "";
    }
  });

  // Guide modal
  const guideBack = document.getElementById("guideBack");
  function openGuide(){
    guideBack.style.display = "flex";
    guideBack.setAttribute("aria-hidden","false");
  }
  function closeGuide(){
    guideBack.style.display = "none";
    guideBack.setAttribute("aria-hidden","true");
  }
  document.getElementById("btnGuide").addEventListener("click", openGuide);
  document.getElementById("btnGuideClose").addEventListener("click", closeGuide);
  guideBack.addEventListener("click", (e)=>{ if(e.target === guideBack) closeGuide(); });

  // Service worker register
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // init
  (function init(){
    const now = new Date();
    selectedDate = now;
    viewYear = now.getFullYear();
    viewMonth = now.getMonth();
    renderCalendar();
    renderToday();
    statusBar.textContent = "ì¤€ë¹„ë¨";
  })();
</script>

  </div> <!-- /.app -->
</body>
</html>
